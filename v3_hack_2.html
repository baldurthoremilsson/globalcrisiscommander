<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="initial-scale=1.0, user-scalable=no"/>
<meta http-equiv="content-type" content="text/html; charset=UTF-8"/>
<title>V3HACK</title>


<style>
html{height:100%;}
body{height:100%;margin:0px;font-family: Helvetica,Arial;}
</style>

<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false"></script>
<script type ="text/javascript" src="v3_epoly.js"></script>
<script type="text/javascript">


//constructor of some kind
function initialize()
{
	var x = new AnimatedMarker();
	x.initialize();
	x.calcRoute(48.861815,2.343256,48.855801,2.324073);
	console.log();
}

function AnimatedMarker()
{
  //globals
  this.map;
  this.directionDisplay;
  this.directionsService;
  this.markerArray = [];
  this.steps = []
  this.position;
  this.marker = null;
  this.polyline = null;
  this.poly2 = null;
  this.speed = 0.000005
  this.wait = 1;
  this.infowindow = null;
  this.timerHandle = null;

  //movement
  this.step = 5; // 5; // metres
  this.tick = 100; // milliseconds
  this.eol;
  this.k=0;
  this.stepnum=0;
  this.speed = "";
  this.lastVertex = 1;
}

  //possible improvements
	var polyLinest = []; //each route
	var markers = [];	//each marker
	var stepsArray = [] //array of step arrays ?

AnimatedMarker.prototype.createMarker = function(latlng, label, html,icon) 
{
	//parametrize later
	var iconImage = "assets/pics/police_32.png";
    var marker = new google.maps.Marker({
        position: latlng,
        map: map,
        title: label,
		icon: iconImage,
        zIndex: Math.round(latlng.lat()*-100000)<<5
        });
        marker.myname = label;
        // gmarkers.push(marker);

    return marker;
}


AnimatedMarker.prototype.initialize = function() {
  infowindow = new google.maps.InfoWindow(
    { 
      size: new google.maps.Size(150,50)
    });

    // Instantiate a directions service.
    directionsService = new google.maps.DirectionsService();
    
    // Create a map and center it on Manhattan.
	var myLatlng = new google.maps.LatLng(48.860706, 2.341182);
	
    var myOptions = {
      zoom: 15,
      mapTypeId: google.maps.MapTypeId.SATELLITE
    }
    map = new google.maps.Map(document.getElementById("map_canvas"), myOptions);
	map.setZoom(15);
    geocoder = new google.maps.Geocoder();
	geocoder.geocode( { 'location': myLatlng}, function(results, status) {
       map.setCenter(results[0].geometry.location);
	});
    
    // Create a renderer for directions and bind it to the map.
    var rendererOptions = {
      //map: map
    }

    directionsDisplay = new google.maps.DirectionsRenderer(rendererOptions);
	
	//This probably needs some work
    polyline = new google.maps.Polyline({
	path: [],
	strokeColor: '#FF0000',
	strokeWeight: 0,
	strokeOpacity: 1.0
    });
    poly2 = new google.maps.Polyline({
	path: [],
	strokeColor: '#FF0000',
	strokeWeight: 0,
	strokeOpacity: 1.0
    });
	
  }


	
	//should have parameters for loc1e, loc2 perhaps
	// !! __ !! also we need to make it so we can add two markers and animate them on the same map !!__!!
	AnimatedMarker.prototype.calcRoute = function(locA_1, locA_2, locB_1, locB_2){
		var self = this;
		if (this.timerHandle) { 
			clearTimeout(timerHandle); 
		}
		/*
		if (marker) 
		{ 
			marker.setMap(null);
		}
		*/
		
		
		polyline.setMap(null);
		poly2.setMap(null);
    	polyline = new google.maps.Polyline({
			path: [],
			strokeColor: '#FF0000',
			strokeWeight: 0,
			strokeOpacity: 1.0
    	});
    	
		poly2 = new google.maps.Polyline({
			path: [],
			strokeColor: '#FF0000',
			strokeWeight: 0,
			strokeOpacity: 1.0
    	});

    	// Create a renderer for directions and bind it to the map.
    	var rendererOptions = {
      		//map: map (IF this is uncommented we will see the polylines on the map) !!_!!_!_!_!_!
    	}
		
		directionsDisplay = new google.maps.DirectionsRenderer(rendererOptions);

			//this needs to be parametrized
			//var loc2 =  new google.maps.LatLng(48.855801, 2.324073);
		  	//var loc1 = new google.maps.LatLng(48.861815, 2.343256);
			var loc1 = new google.maps.LatLng(locA_1, locA_2);
			var loc2 = new google.maps.LatLng(locB_1, locB_2);
			//this needs to be parametrized
			
			
	    	//var start = document.getElementById("start").value;
	    	//var end = document.getElementById("end").value;
	
			//Use driving options
			var travelMode = google.maps.DirectionsTravelMode.DRIVING
			
			//create the request to the directions thingie from google
	    	var request = {
	        	origin: loc1,
	        	destination: loc2,
	        	travelMode: travelMode
	    	};

		// Route the directions and pass the response to a
		// function to create markers for each step.
  		directionsService.route(request, function(response, status) {
			//var self = this;
			//document.write(self);
    		if (status == google.maps.DirectionsStatus.OK){
				directionsDisplay.setDirections(response);

        		//var bounds = new google.maps.LatLngBounds();
        		var route = response.routes[0];
        		startLocation = new Object();
        		endLocation = new Object();

        		// For each route, display summary information.
				var path = response.routes[0].overview_path;
				var legs = response.routes[0].legs;
        		for (i=0;i<legs.length;i++) {
          			if (i == 0) { 
            			startLocation.latlng = legs[i].start_location;
            			startLocation.address = legs[i].start_address;
            			// marker = google.maps.Marker({map:map,position: startLocation.latlng});
            self.marker = self.createMarker(legs[i].start_location,"start",legs[i].start_address,"green");
          	}
          endLocation.latlng = legs[i].end_location;
          endLocation.address = legs[i].end_address;
          var steps = legs[i].steps;
          for (j=0;j<steps.length;j++) {
            var nextSegment = steps[j].path;
            for (k=0;k<nextSegment.length;k++) {
              polyline.getPath().push(nextSegment[k]);
            }
          }
        }

	self.startAnimation();
    }                                                    
 });
}

//=============== animation functions ======================
AnimatedMarker.prototype.updatePoly = function(d) 
{
	if (this.poly2.getPath().getLength() > 100) 
	{
		this.poly2=new google.maps.Polyline([this.polyline.getPath().getAt(lastVertex-1)]);
	}

	if (this.polyline.GetIndexAtDistance(d) < lastVertex+2) 
	{
		if (this..poly2.getPath().getLength()>1) 
		{
			this.poly2.getPath().removeAt(this.poly2.getPath().getLength()-1)
		}
		this.poly2.getPath().insertAt(this.poly2.getPath().getLength(),this.polyline.GetPointAtDistance(d));
	} 
	else 
	{
		this.poly2.getPath().insertAt(this.poly2.getPath().getLength(),endLocation.latlng);
	}
}


	  //this needs to be bound to some marker object
       AnimatedMarker.prototype.animate = function(d) {
        if (d>eol) {
          this.marker.setPosition(endLocation.latlng);
          return;
        }
        var p = polyline.GetPointAtDistance(d);
        this.marker.setPosition(p);
        //this.updatePoly(d);
        timerHandle = setTimeout("this.animate("+(d+this.step)+")", this.tick);
      }

//this needs to be bound to some marker object
AnimatedMarker.prototype.startAnimation = function() {
        eol=polyline.Distance();
        this.poly2 = new google.maps.Polyline({path: [this.polyline.getPath().getAt(0)], strokeColor:"#0000FF", 	
				strokeWeight:10});
        setTimeout("this.animate(50)",2000);  // Allow time for the initial map display
}



//=============== ~animation funcitons =====================

//var loc2 =  new google.maps.LatLng(48.855801, 2.324073);
//var loc1 = new google.maps.LatLng(48.861815, 2.343256);

</script>
</head>
<body onload="initialize()">

<div id="map_canvas" style="width:100%;height:100%;"></div>
</body>
</html>
